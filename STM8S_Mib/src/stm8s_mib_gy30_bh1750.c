/**
 ******************************************************************************
 * @file stm8s_mib_gy30_bh1750.c
 * @brief
 * @author MYMEDIA Co., Ltd.
 * @version V1.0.0
 * @date 2023.1.6
 ******************************************************************************
 */
#include "stm8s.h"
#include "stm8s_mib_i2c.h"
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
#define GY30_ADDR_WRITE 0x46
#define GY30_ADDR_READ 0x47
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// BH1750 명령어
#define BH1750_POWER_ON 0x01
#define BH1750_RESET 0x07
#define BH1750_CONT_H_RES 0x10 // 1 Lux 정밀도, 연속 측정 모드
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
uint16_t GY30_ReadLux(void);
void GY30_Init(void);
////////////////////////////////////////////////////////////////////////////////////////////////////  
////////////////////////////////////////////////////////////////////////////////////////////////////  
////////////////////////////////////////////////////////////////////////////////////////////////////  
/**
 * @brief GY-30 초기화 및 측정 시작
 */
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
void GY30_Init(void)
{
  // 1. 전원 켜기
  I2C_Start();
  I2C_SendAddress(GY30_ADDR_WRITE);
  I2C_WriteByte(BH1750_POWER_ON);
  I2C_Stop();

  // 2. 측정 모드 설정 (High Resolution Mode)
  I2C_Start();
  I2C_SendAddress(GY30_ADDR_WRITE);
  I2C_WriteByte(BH1750_CONT_H_RES);
  I2C_Stop();
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
/**
 * @brief 현재 조도 값을 읽어 Lux 단위로 반환합니다.
 */
uint16_t GY30_ReadLux(void)
{
  uint8_t highByte, lowByte;
  uint16_t rawValue;

  I2C_Start();
  I2C_SendAddress(GY30_ADDR_READ);

  // 첫 번째 바이트 읽기 (MSB)
  while (!(I2C->SR1 & 0x40))
    ; // RXNE 대기
  highByte = I2C->DR;

  // 두 번째 바이트 읽기 (LSB) 및 NACK/STOP
  I2C->CR2 &= ~0x04; // NACK
  I2C_Stop();
  while (!(I2C->SR1 & 0x40))
    ;
  lowByte = I2C->DR;

  I2C->CR2 |= 0x04; // 다음 통신을 위해 ACK 복구

  // 데이터 조합
  rawValue = (highByte << 8) | lowByte;

  // Lux 계산 공식: 결과값 / 1.2
  return (uint16_t)((rawValue * 10) / 12);
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
