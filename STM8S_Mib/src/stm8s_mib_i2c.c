/**
  ******************************************************************************
  * @file stm8s_mib_i2c.c
  * @brief 
  * @author MYMEDIA Co., Ltd.
  * @version V1.0.0
  * @date 2023.1.6
  ******************************************************************************
  */
#include "stm8s.h"
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// I2C 초기화 (100kHz 표준 모드)
void I2C_Config(void)
{
  I2C->CR1 &= ~0x01; // PE = 0, 우선 I2C 비활성화

  I2C->FREQR = 16; // 입력 클럭 주파수 (16MHz 기준)
  I2C->CCRL = 80;  // 100kHz 설정 (16MHz / (2 * 100kHz))
  I2C->CCRH = 0;

  I2C->TRISER = 17; // 최대 상승 시간 설정
  I2C->CR1 |= 0x01; // PE = 1, I2C 활성화
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// I2C 시작 조건 전송
void I2C_Start(void)
{
  I2C->CR2 |= 0x01; // START 비트 세팅
  while (!(I2C->SR1 & 0x01))
    ; // SB 비트 대기
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// I2C 주소 전송
void I2C_SendAddress(uint8_t addr)
{
  I2C->DR = addr;
  while (!(I2C->SR1 & 0x02))
    ;             // ADDR 비트 대기
  (void)I2C->SR3; // SR3 읽어서 ADDR 플래그 클리어
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// I2C 데이터 전송
void I2C_WriteByte(uint8_t data)
{
  I2C->DR = data;
  while (!(I2C->SR1 & 0x80))
    ; // TXE 비트 대기
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// I2C 정지 조건 전송
void I2C_Stop(void)
{
  I2C->CR2 |= 0x02; // STOP 비트 세팅
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////