/**
  ******************************************************************************
  * @file stm8s_mib_pcf8591.c
  * @brief 
  * @author MYMEDIA Co., Ltd.
  * @version V1.0.0
  * @date 2023.1.6
  ******************************************************************************
  */
#include "stm8s.h"
#include "stm8s_mib_i2c.h"
void PCF8591_WriteDAC(uint8_t val);
uint8_t PCF8591_ReadADC(uint8_t channel);
#define PCF8591_ADDR 0x90 // 7비트 주소 0x48을 왼쪽으로 1비트 시프트한 값
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// PCF8591 ADC 값 읽기 (channel: 0~3)
uint8_t PCF8591_ReadADC(uint8_t channel)
{
  uint8_t value;

  // 1. 제어 바이트 전송 (채널 선택)
  I2C_Start();
  I2C_SendAddress(PCF8591_ADDR);
  I2C_WriteByte(channel & 0x03); // 0x00~0x03 채널 선택
  I2C_Stop();

  // 2. 데이터 읽기
  I2C_Start();
  I2C_SendAddress(PCF8591_ADDR | 0x01); // Read 모드 (0x91)

  // 첫 번째 읽기 (Dummy Read: 이전 변환 값이 나옴)
  while (!(I2C->SR1 & 0x40))
    ; // RXNE 대기
  value = I2C->DR;

  // 두 번째 읽기 (실제 현재 채널 값)
  I2C->CR2 &= ~0x04; // ACK 비트 끄기 (마지막 바이트이므로 NACK 필요)
  I2C_Stop();        // STOP 예약
  while (!(I2C->SR1 & 0x40))
    ;
  value = I2C->DR;

  I2C->CR2 |= 0x04; // 다음 통신을 위해 ACK 다시 켜기

  return value;
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
// PCF8591 DAC 출력 설정 (0~255)
void PCF8591_WriteDAC(uint8_t val)
{
  I2C_Start();
  I2C_SendAddress(PCF8591_ADDR);
  I2C_WriteByte(0x40); // 제어 바이트: DAC Enable (비트 6을 1로)
  I2C_WriteByte(val);  // 아날로그 출력 값
  I2C_Stop();
}
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////